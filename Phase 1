{
 "cells": [
  {
   "cell_type": "code",
   "execution_count": 1,
   "id": "43c2b749",
   "metadata": {
    "_cell_guid": "b1076dfc-b9ad-4769-8c92-a6c4dae69d19",
    "_uuid": "8f2839f25d086af736a60e9eeb907d3b93b6e0e5",
    "execution": {
     "iopub.execute_input": "2025-11-27T02:58:15.247410Z",
     "iopub.status.busy": "2025-11-27T02:58:15.246796Z",
     "iopub.status.idle": "2025-11-27T02:58:31.339247Z",
     "shell.execute_reply": "2025-11-27T02:58:31.338317Z"
    },
    "papermill": {
     "duration": 16.100205,
     "end_time": "2025-11-27T02:58:31.340818",
     "exception": false,
     "start_time": "2025-11-27T02:58:15.240613",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "å¼€å§‹è¯»å– 18 å‘¨æ•°æ®...\n",
      "\n",
      "æ­£åœ¨è¯»å– week 01 ...\n",
      "æ­£åœ¨è¯»å– week 02 ...\n",
      "æ­£åœ¨è¯»å– week 03 ...\n",
      "æ­£åœ¨è¯»å– week 04 ...\n",
      "æ­£åœ¨è¯»å– week 05 ...\n",
      "æ­£åœ¨è¯»å– week 06 ...\n",
      "æ­£åœ¨è¯»å– week 07 ...\n",
      "æ­£åœ¨è¯»å– week 08 ...\n",
      "æ­£åœ¨è¯»å– week 09 ...\n",
      "æ­£åœ¨è¯»å– week 10 ...\n",
      "æ­£åœ¨è¯»å– week 11 ...\n",
      "æ­£åœ¨è¯»å– week 12 ...\n",
      "æ­£åœ¨è¯»å– week 13 ...\n",
      "æ­£åœ¨è¯»å– week 14 ...\n",
      "æ­£åœ¨è¯»å– week 15 ...\n",
      "æ­£åœ¨è¯»å– week 16 ...\n",
      "æ­£åœ¨è¯»å– week 17 ...\n",
      "æ­£åœ¨è¯»å– week 18 ...\n",
      "\n",
      "18å‘¨æ•°æ®è¯»å–å®Œæˆï¼\n",
      "\n",
      "ğŸ“Œ ã€input_df æ€»ä½“ä¿¡æ¯ã€‘\n",
      "input_df shape: (4880579, 24)\n",
      "week åˆ†å¸ƒ: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18]\n",
      "\n",
      "ğŸ“Œ ã€output_df æ€»ä½“ä¿¡æ¯ã€‘\n",
      "output_df shape: (562936, 7)\n",
      "week åˆ†å¸ƒ: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18]\n",
      "\n",
      "ğŸ“Œ input_df å‰å‡ è¡Œï¼š\n",
      "      game_id  play_id  player_to_predict  nfl_id  frame_id play_direction  absolute_yardline_number player_name player_height  player_weight player_birth_date player_position player_side  \\\n",
      "0  2023090700      101              False   54527         1          right                        42  Bryan Cook           6-1            210        1999-09-07              FS     Defense   \n",
      "1  2023090700      101              False   54527         2          right                        42  Bryan Cook           6-1            210        1999-09-07              FS     Defense   \n",
      "2  2023090700      101              False   54527         3          right                        42  Bryan Cook           6-1            210        1999-09-07              FS     Defense   \n",
      "\n",
      "          player_role      x      y     s     a     dir       o  num_frames_output  ball_land_x  ball_land_y  week  \n",
      "0  Defensive Coverage  52.33  36.94  0.09  0.39  322.40  238.24                 21    63.259998        -0.22     1  \n",
      "1  Defensive Coverage  52.33  36.94  0.04  0.61  200.89  236.05                 21    63.259998        -0.22     1  \n",
      "2  Defensive Coverage  52.33  36.93  0.12  0.73  147.55  240.60                 21    63.259998        -0.22     1  \n",
      "\n",
      "ğŸ“Œ output_df å‰å‡ è¡Œï¼š\n",
      "      game_id  play_id  nfl_id  frame_id      x      y  week\n",
      "0  2023090700      101   46137         1  56.22  17.28     1\n",
      "1  2023090700      101   46137         2  56.63  16.88     1\n",
      "2  2023090700      101   46137         3  57.06  16.46     1\n",
      "\n",
      "ğŸ“Œ play_direction åˆ†å¸ƒï¼š\n",
      "play_direction\n",
      "right    2459074\n",
      "left     2421505\n",
      "Name: count, dtype: int64\n"
     ]
    }
   ],
   "source": [
    "import pandas as pd\n",
    "\n",
    "# æ˜¾ç¤ºè®¾ç½®\n",
    "pd.set_option(\"display.max_columns\", 50)\n",
    "pd.set_option(\"display.width\", 200)\n",
    "\n",
    "# ===== Step 1 Â· Load All 18 Weeks =====\n",
    "weeks = [f\"{w:02d}\" for w in range(1, 19)]  # 01â€“18\n",
    "\n",
    "input_list = []\n",
    "output_list = []\n",
    "\n",
    "print(\"å¼€å§‹è¯»å– 18 å‘¨æ•°æ®...\\n\")\n",
    "\n",
    "for w in weeks:\n",
    "    in_path = f\"/kaggle/input/nfl-big-data-bowl-2026-prediction/train/input_2023_w{w}.csv\"\n",
    "    out_path = f\"/kaggle/input/nfl-big-data-bowl-2026-prediction/train/output_2023_w{w}.csv\"\n",
    "\n",
    "    print(f\"æ­£åœ¨è¯»å– week {w} ...\")\n",
    "    \n",
    "    # è¯»å– input/output\n",
    "    df_in = pd.read_csv(in_path)\n",
    "    df_out = pd.read_csv(out_path)\n",
    "\n",
    "    # æ·»åŠ  week å­—æ®µï¼ˆæ–¹ä¾¿åç»­ debug / åˆ†æï¼‰\n",
    "    df_in[\"week\"] = int(w)\n",
    "    df_out[\"week\"] = int(w)\n",
    "\n",
    "    input_list.append(df_in)\n",
    "    output_list.append(df_out)\n",
    "\n",
    "# åˆå¹¶\n",
    "input_df = pd.concat(input_list, ignore_index=True)\n",
    "output_df = pd.concat(output_list, ignore_index=True)\n",
    "\n",
    "print(\"\\n18å‘¨æ•°æ®è¯»å–å®Œæˆï¼\")\n",
    "\n",
    "# ===== Step 1 Â· Verification =====\n",
    "print(\"\\nğŸ“Œ ã€input_df æ€»ä½“ä¿¡æ¯ã€‘\")\n",
    "print(\"input_df shape:\", input_df.shape)\n",
    "print(\"week åˆ†å¸ƒ:\", sorted(input_df['week'].unique().tolist()))\n",
    "\n",
    "print(\"\\nğŸ“Œ ã€output_df æ€»ä½“ä¿¡æ¯ã€‘\")\n",
    "print(\"output_df shape:\", output_df.shape)\n",
    "print(\"week åˆ†å¸ƒ:\", sorted(output_df['week'].unique().tolist()))\n",
    "\n",
    "print(\"\\nğŸ“Œ input_df å‰å‡ è¡Œï¼š\")\n",
    "print(input_df.head(3))\n",
    "\n",
    "print(\"\\nğŸ“Œ output_df å‰å‡ è¡Œï¼š\")\n",
    "print(output_df.head(3))\n",
    "\n",
    "print(\"\\nğŸ“Œ play_direction åˆ†å¸ƒï¼š\")\n",
    "print(input_df['play_direction'].value_counts(dropna=False))\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 2,
   "id": "6734c040",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T02:58:31.352166Z",
     "iopub.status.busy": "2025-11-27T02:58:31.351926Z",
     "iopub.status.idle": "2025-11-27T02:58:31.357045Z",
     "shell.execute_reply": "2025-11-27T02:58:31.356406Z"
    },
    "papermill": {
     "duration": 0.011877,
     "end_time": "2025-11-27T02:58:31.358057",
     "exception": false,
     "start_time": "2025-11-27T02:58:31.346180",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Config loaded! Feature count = 18\n"
     ]
    }
   ],
   "source": [
    "# ============================================\n",
    "# Config for Phase 1\n",
    "# ============================================\n",
    "class CFG:\n",
    "    # Data\n",
    "    WEEKS = list(range(1, 19))          # 18 weeks\n",
    "    T_IN = 32                           # input sequence length\n",
    "    T_OUT = 21                          # output length\n",
    "\n",
    "    # Feature Engineering (Phase 1)\n",
    "    FEATURE_COLS = [\n",
    "        \"x\", \"y\", \"s\", \"a\",\n",
    "        \"dir\", \"o\",\n",
    "        \"dir_sin\", \"dir_cos\",\n",
    "        \"o_sin\", \"o_cos\",\n",
    "        \"vx\", \"vy\",\n",
    "        \"ball_land_x\", \"ball_land_y\",\n",
    "        \"rel_x\", \"rel_y\",\n",
    "        \"dist_to_land\",\n",
    "        \"frame_left\"\n",
    "    ]\n",
    "\n",
    "    # Model\n",
    "    D_MODEL = 192                       # tonight's target model\n",
    "    NHEAD = 8\n",
    "    NUM_LAYERS = 4\n",
    "    LR = 3e-4\n",
    "    BATCH_SIZE = 128\n",
    "    EPOCHS = 12\n",
    "\n",
    "    # Paths\n",
    "    TRAIN_DIR = \"/kaggle/input/nfl-big-data-bowl-2026-prediction/train/\"\n",
    "    MODEL_SAVE_PATH = \"/kaggle/working/model_phase1.pt\"\n",
    "\n",
    "print(\"Config loaded! Feature count =\", len(CFG.FEATURE_COLS))\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 3,
   "id": "c12982dc",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T02:58:31.369299Z",
     "iopub.status.busy": "2025-11-27T02:58:31.368724Z",
     "iopub.status.idle": "2025-11-27T02:58:31.373818Z",
     "shell.execute_reply": "2025-11-27T02:58:31.373175Z"
    },
    "papermill": {
     "duration": 0.011787,
     "end_time": "2025-11-27T02:58:31.374910",
     "exception": false,
     "start_time": "2025-11-27T02:58:31.363123",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "import numpy as np\n",
    "import pandas as pd\n",
    "\n",
    "def normalize_direction(df: pd.DataFrame) -> pd.DataFrame:\n",
    "    df = df.copy()\n",
    "    is_left = df[\"play_direction\"] == \"left\"\n",
    "\n",
    "    # 1) mirror x, y\n",
    "    df.loc[is_left, \"x\"] = 120.0 - df.loc[is_left, \"x\"]\n",
    "    df.loc[is_left, \"y\"] = 53.3 - df.loc[is_left, \"y\"]\n",
    "\n",
    "    # 2) mirror angles\n",
    "    df.loc[is_left, \"dir\"] = (180.0 - df.loc[is_left, \"dir\"]) % 360\n",
    "    df.loc[is_left, \"o\"]   = (180.0 - df.loc[is_left, \"o\"]) % 360\n",
    "\n",
    "    return df"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 4,
   "id": "25184238",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T02:58:31.386014Z",
     "iopub.status.busy": "2025-11-27T02:58:31.385554Z",
     "iopub.status.idle": "2025-11-27T02:58:31.389399Z",
     "shell.execute_reply": "2025-11-27T02:58:31.388837Z"
    },
    "papermill": {
     "duration": 0.010616,
     "end_time": "2025-11-27T02:58:31.390547",
     "exception": false,
     "start_time": "2025-11-27T02:58:31.379931",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "def add_angle_features(df: pd.DataFrame) -> pd.DataFrame:\n",
    "    df = df.copy()\n",
    "    dir_rad = np.deg2rad(df[\"dir\"])\n",
    "    o_rad = np.deg2rad(df[\"o\"])\n",
    "\n",
    "    # æ·»åŠ æ–¹å‘ sin/cos\n",
    "    df[\"dir_sin\"] = np.sin(dir_rad)\n",
    "    df[\"dir_cos\"] = np.cos(dir_rad)\n",
    "    df[\"o_sin\"] = np.sin(o_rad)\n",
    "    df[\"o_cos\"] = np.cos(o_rad)\n",
    "\n",
    "    return df"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 5,
   "id": "6654b510",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T02:58:31.401502Z",
     "iopub.status.busy": "2025-11-27T02:58:31.401041Z",
     "iopub.status.idle": "2025-11-27T02:58:31.405474Z",
     "shell.execute_reply": "2025-11-27T02:58:31.404887Z"
    },
    "papermill": {
     "duration": 0.010999,
     "end_time": "2025-11-27T02:58:31.406568",
     "exception": false,
     "start_time": "2025-11-27T02:58:31.395569",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "def add_phase1_features(df: pd.DataFrame) -> pd.DataFrame:\n",
    "    df = df.copy()\n",
    "\n",
    "    # === vx, vy ===\n",
    "    rad = np.deg2rad(df[\"dir\"])\n",
    "    df[\"vx\"] = df[\"s\"] * np.cos(rad)\n",
    "    df[\"vy\"] = df[\"s\"] * np.sin(rad)\n",
    "\n",
    "    # === relative position to ball landing ===\n",
    "    df[\"rel_x\"] = df[\"ball_land_x\"] - df[\"x\"]\n",
    "    df[\"rel_y\"] = df[\"ball_land_y\"] - df[\"y\"]\n",
    "\n",
    "    # === distance to landing ===\n",
    "    df[\"dist_to_land\"] = np.sqrt(df[\"rel_x\"]**2 + df[\"rel_y\"]**2)\n",
    "\n",
    "    # === frame_left ===\n",
    "    df[\"frame_left\"] = df[\"num_frames_output\"] - df[\"frame_id\"]\n",
    "\n",
    "    return df\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 6,
   "id": "1d4c4dbf",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T02:58:31.417326Z",
     "iopub.status.busy": "2025-11-27T02:58:31.416914Z",
     "iopub.status.idle": "2025-11-27T02:58:31.588576Z",
     "shell.execute_reply": "2025-11-27T02:58:31.587644Z"
    },
    "papermill": {
     "duration": 0.178295,
     "end_time": "2025-11-27T02:58:31.589816",
     "exception": false,
     "start_time": "2025-11-27T02:58:31.411521",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "ğŸ“Œ æ–°å¢ç‰¹å¾åçš„ç¤ºä¾‹ï¼ˆ5 è¡Œï¼‰ï¼š\n",
      "              x      y     s     a     dir       o        vx        vy      rel_x      rel_y  dist_to_land  frame_left\n",
      "33376      5.97  23.71  0.06  0.05  236.80   88.42 -0.032854 -0.050206   4.010000   3.550000      5.355614           4\n",
      "3447956   51.10  12.57  6.22  1.01  194.70  142.85 -6.016405 -1.578374  23.900000  -6.490000     24.765502          -8\n",
      "1239499  104.12  37.91  0.02  0.02   96.42  123.34 -0.002236  0.019875 -84.880000  -4.470001     84.997620           5\n",
      "52865     57.58  29.52  3.63  2.26  180.78  119.11 -3.629664 -0.049416   6.820002 -22.460000     23.472623         -11\n",
      "2122153   45.58  17.03  1.09  2.26  267.21   69.07 -0.053056 -1.088708  15.359999  32.450000     35.901700           4\n"
     ]
    }
   ],
   "source": [
    "\n",
    "# æµ‹è¯•ï¼ˆéšæœºæŠ½æ ·5è¡Œï¼‰\n",
    "test_df3 = input_df.sample(5, random_state=0).copy()\n",
    "test_df3 = normalize_direction(test_df3)\n",
    "test_df3 = add_angle_features(test_df3)\n",
    "test_df3 = add_phase1_features(test_df3)\n",
    "\n",
    "print(\"ğŸ“Œ æ–°å¢ç‰¹å¾åçš„ç¤ºä¾‹ï¼ˆ5 è¡Œï¼‰ï¼š\")\n",
    "print(test_df3[[\n",
    "    \"x\",\"y\",\"s\",\"a\",\"dir\",\"o\",\n",
    "    \"vx\",\"vy\",\n",
    "    \"rel_x\",\"rel_y\",\"dist_to_land\",\n",
    "    \"frame_left\"\n",
    "]])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 7,
   "id": "40540f05",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T02:58:31.601012Z",
     "iopub.status.busy": "2025-11-27T02:58:31.600477Z",
     "iopub.status.idle": "2025-11-27T02:58:40.040332Z",
     "shell.execute_reply": "2025-11-27T02:58:40.039054Z"
    },
    "papermill": {
     "duration": 8.447205,
     "end_time": "2025-11-27T02:58:40.042154",
     "exception": false,
     "start_time": "2025-11-27T02:58:31.594949",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "ğŸ“Œ å¼€å§‹å¯¹å…¨é‡ input_df åš Phase 1 ç‰¹å¾å·¥ç¨‹...\n",
      "âœ… Phase 1 ç‰¹å¾å·¥ç¨‹å®Œæˆï¼\n",
      "ğŸ“Œ ç¼ºå¤±çš„ç‰¹å¾åˆ—: []\n",
      "\n",
      "ğŸ“Œ æ–°å¢ç‰¹å¾ NaN æ•°é‡ï¼š\n",
      "x               0\n",
      "y               0\n",
      "s               0\n",
      "a               0\n",
      "dir             0\n",
      "o               0\n",
      "dir_sin         0\n",
      "dir_cos         0\n",
      "o_sin           0\n",
      "o_cos           0\n",
      "vx              0\n",
      "vy              0\n",
      "ball_land_x     0\n",
      "ball_land_y     0\n",
      "rel_x           0\n",
      "rel_y           0\n",
      "dist_to_land    0\n",
      "frame_left      0\n",
      "dtype: int64\n",
      "\n",
      "ğŸ“Œ ç‰¹å¾å€¼èŒƒå›´ç»Ÿè®¡ï¼ˆéƒ¨åˆ†å–å€¼ï¼‰ï¼š\n",
      "                  count        mean         std         min        25%         50%         75%         max\n",
      "x             4880579.0   60.827770   23.479941    1.370000  42.210000   57.590000   77.830000  119.860000\n",
      "y             4880579.0   26.665868   10.007496    0.420000  18.870000   26.570000   34.500000   52.860000\n",
      "s             4880579.0    3.019878    2.227939    0.000000   1.090000    2.720000    4.620000   12.530000\n",
      "a             4880579.0    2.118335    1.415794    0.000000   1.010000    1.920000    3.040000   17.120000\n",
      "dir           4880579.0  179.805860  100.218963    0.000000  90.140000  179.570000  269.580000  360.000000\n",
      "o             4880579.0  180.089184   96.198508    0.000000  91.370000  180.120000  268.770000  360.000000\n",
      "dir_sin       4880579.0    0.000912    0.783832   -1.000000  -0.860386    0.003840    0.859763    1.000000\n",
      "dir_cos       4880579.0   -0.008201    0.620919   -1.000000  -0.523094   -0.004887    0.497125    1.000000\n",
      "o_sin         4880579.0    0.000795    0.838633   -1.000000  -0.931247   -0.001222    0.934142    1.000000\n",
      "o_cos         4880579.0   -0.028772    0.543936   -1.000000  -0.398429   -0.022687    0.324578    1.000000\n",
      "vx            4880579.0   -0.043655    2.296241  -10.049202  -0.992612    0.000000    0.899911    9.755046\n",
      "vy            4880579.0   -0.003630    2.967952  -10.309109  -1.656028    0.000000    1.654853   10.128261\n",
      "ball_land_x   4880579.0   60.515810   25.296428   -5.260000  42.610001   60.509998   78.470001  125.849998\n",
      "ball_land_y   4880579.0   26.637664   15.438138   -3.910000  13.300000   26.469999   39.869999   57.330002\n",
      "rel_x         4880579.0   -0.311960   33.922211 -123.420000 -10.295000    2.949999   17.619998  106.679998\n",
      "rel_y         4880579.0   -0.028204   18.410733  -53.110000 -13.840000   -0.130001   13.790001   52.590001\n",
      "dist_to_land  4880579.0   31.519370   22.277764    0.010002  15.229012   25.985960   41.630754  126.174942\n",
      "frame_left    4880579.0   -4.490318   11.947753 -115.000000 -11.000000   -3.000000    4.000000   93.000000\n",
      "\n",
      "ğŸ“Œ å®Œæ•´ç‰¹å¾åçš„å‰ 5 è¡Œï¼š\n",
      "      game_id  play_id  player_to_predict  nfl_id  frame_id play_direction  absolute_yardline_number player_name player_height  player_weight player_birth_date player_position player_side  \\\n",
      "0  2023090700      101              False   54527         1          right                        42  Bryan Cook           6-1            210        1999-09-07              FS     Defense   \n",
      "1  2023090700      101              False   54527         2          right                        42  Bryan Cook           6-1            210        1999-09-07              FS     Defense   \n",
      "2  2023090700      101              False   54527         3          right                        42  Bryan Cook           6-1            210        1999-09-07              FS     Defense   \n",
      "3  2023090700      101              False   54527         4          right                        42  Bryan Cook           6-1            210        1999-09-07              FS     Defense   \n",
      "4  2023090700      101              False   54527         5          right                        42  Bryan Cook           6-1            210        1999-09-07              FS     Defense   \n",
      "\n",
      "          player_role      x      y     s     a     dir       o  num_frames_output  ball_land_x  ball_land_y  week   dir_sin   dir_cos     o_sin     o_cos        vx        vy      rel_x  rel_y  \\\n",
      "0  Defensive Coverage  52.33  36.94  0.09  0.39  322.40  238.24                 21    63.259998        -0.22     1 -0.610145  0.792290 -0.850260 -0.526362  0.071306 -0.054913  10.929998 -37.16   \n",
      "1  Defensive Coverage  52.33  36.94  0.04  0.61  200.89  236.05                 21    63.259998        -0.22     1 -0.356575 -0.934267 -0.829525 -0.558469 -0.037371 -0.014263  10.929998 -37.16   \n",
      "2  Defensive Coverage  52.33  36.93  0.12  0.73  147.55  240.60                 21    63.259998        -0.22     1  0.536563 -0.843860 -0.871214 -0.490904 -0.101263  0.064388  10.929998 -37.15   \n",
      "3  Defensive Coverage  52.35  36.92  0.23  0.81  131.40  244.25                 21    63.259998        -0.22     1  0.750111 -0.661312 -0.900698 -0.434445 -0.152102  0.172526  10.909998 -37.14   \n",
      "4  Defensive Coverage  52.37  36.90  0.35  0.82  123.26  244.25                 21    63.259998        -0.22     1  0.836190 -0.548439 -0.900698 -0.434445 -0.191954  0.292667  10.889998 -37.12   \n",
      "\n",
      "   dist_to_land  frame_left  \n",
      "0     38.734099          20  \n",
      "1     38.734099          19  \n",
      "2     38.724506          18  \n",
      "3     38.709271          17  \n",
      "4     38.684447          16  \n"
     ]
    }
   ],
   "source": [
    "# =========== Step 2D: Apply all Phase 1 features to full input_df ===========\n",
    "\n",
    "print(\"ğŸ“Œ å¼€å§‹å¯¹å…¨é‡ input_df åš Phase 1 ç‰¹å¾å·¥ç¨‹...\")\n",
    "\n",
    "input_df_feat = normalize_direction(input_df)\n",
    "input_df_feat = add_angle_features(input_df_feat)\n",
    "input_df_feat = add_phase1_features(input_df_feat)\n",
    "\n",
    "print(\"âœ… Phase 1 ç‰¹å¾å·¥ç¨‹å®Œæˆï¼\")\n",
    "\n",
    "# ============ æ£€æŸ¥ 18 ä¸ªç‰¹å¾æ˜¯å¦å­˜åœ¨ ============\n",
    "\n",
    "missing_cols = [c for c in CFG.FEATURE_COLS if c not in input_df_feat.columns]\n",
    "print(\"ğŸ“Œ ç¼ºå¤±çš„ç‰¹å¾åˆ—:\", missing_cols)\n",
    "\n",
    "# ============ æ£€æŸ¥ NaN ============\n",
    "print(\"\\nğŸ“Œ æ–°å¢ç‰¹å¾ NaN æ•°é‡ï¼š\")\n",
    "print(input_df_feat[CFG.FEATURE_COLS].isna().sum())\n",
    "\n",
    "# ============ æŸ¥çœ‹æ•°å€¼èŒƒå›´ ============\n",
    "print(\"\\nğŸ“Œ ç‰¹å¾å€¼èŒƒå›´ç»Ÿè®¡ï¼ˆéƒ¨åˆ†å–å€¼ï¼‰ï¼š\")\n",
    "print(input_df_feat[CFG.FEATURE_COLS].describe().T)\n",
    "\n",
    "# ============ æŸ¥çœ‹å‰ 5 è¡Œ ============\n",
    "print(\"\\nğŸ“Œ å®Œæ•´ç‰¹å¾åçš„å‰ 5 è¡Œï¼š\")\n",
    "print(input_df_feat.head())\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 8,
   "id": "37efece3",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T02:58:40.054849Z",
     "iopub.status.busy": "2025-11-27T02:58:40.054313Z",
     "iopub.status.idle": "2025-11-27T02:58:40.794489Z",
     "shell.execute_reply": "2025-11-27T02:58:40.793479Z"
    },
    "papermill": {
     "duration": 0.747489,
     "end_time": "2025-11-27T02:58:40.795792",
     "exception": false,
     "start_time": "2025-11-27T02:58:40.048303",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "ğŸ“Œ è¿‡æ»¤å input_df_pred è¡Œæ•°: (1303440, 34)\n",
      "ğŸ“Œ player_to_predict åˆ†å¸ƒ:\n",
      "player_to_predict\n",
      "True    1303440\n",
      "Name: count, dtype: int64\n",
      "\n",
      "ğŸ“Œ play_direction(after filtering) åˆ†å¸ƒ:\n",
      "play_direction\n",
      "right    657141\n",
      "left     646299\n",
      "Name: count, dtype: int64\n",
      "\n",
      "ğŸ“Œ è¿‡æ»¤åçš„å‰5è¡Œ:\n",
      "       game_id  play_id  player_to_predict  nfl_id  frame_id play_direction  absolute_yardline_number  player_name player_height  player_weight player_birth_date player_position player_side  \\\n",
      "26  2023090700      101               True   46137         1          right                        42  Justin Reid           6-1            204        1997-02-15              SS     Defense   \n",
      "27  2023090700      101               True   46137         2          right                        42  Justin Reid           6-1            204        1997-02-15              SS     Defense   \n",
      "28  2023090700      101               True   46137         3          right                        42  Justin Reid           6-1            204        1997-02-15              SS     Defense   \n",
      "29  2023090700      101               True   46137         4          right                        42  Justin Reid           6-1            204        1997-02-15              SS     Defense   \n",
      "30  2023090700      101               True   46137         5          right                        42  Justin Reid           6-1            204        1997-02-15              SS     Defense   \n",
      "\n",
      "           player_role      x      y     s     a     dir       o  num_frames_output  ball_land_x  ball_land_y  week   dir_sin   dir_cos     o_sin     o_cos        vx        vy      rel_x  rel_y  \\\n",
      "26  Defensive Coverage  51.32  20.69  0.31  0.49   79.43  267.68                 21    63.259998        -0.22     1  0.983032  0.183437 -0.999180 -0.040481  0.056865  0.304740  11.939998 -20.91   \n",
      "27  Defensive Coverage  51.35  20.66  0.36  0.74  118.07  268.66                 21    63.259998        -0.22     1  0.882373 -0.470550 -0.999727 -0.023385 -0.169398  0.317654  11.909998 -20.88   \n",
      "28  Defensive Coverage  51.39  20.63  0.44  0.76  130.89  269.78                 21    63.259998        -0.22     1  0.755968 -0.654609 -0.999993 -0.003840 -0.288028  0.332626  11.869998 -20.85   \n",
      "29  Defensive Coverage  51.43  20.61  0.48  0.62  134.50  269.78                 21    63.259998        -0.22     1  0.713250 -0.700909 -0.999993 -0.003840 -0.336436  0.342360  11.829998 -20.83   \n",
      "30  Defensive Coverage  51.48  20.58  0.54  0.44  129.79  269.06                 21    63.259998        -0.22     1  0.768395 -0.639976 -0.999865 -0.016405 -0.345587  0.414933  11.779998 -20.80   \n",
      "\n",
      "    dist_to_land  frame_left  \n",
      "26     24.078863          20  \n",
      "27     24.037938          19  \n",
      "28     23.992069          18  \n",
      "29     23.954911          17  \n",
      "30     23.904149          16  \n"
     ]
    }
   ],
   "source": [
    "# ========== Step 3A: åªä¿ç•™éœ€è¦é¢„æµ‹çš„çƒå‘˜ ==========\n",
    "input_df_pred = input_df_feat[input_df_feat[\"player_to_predict\"] == True].copy()\n",
    "\n",
    "print(\"ğŸ“Œ è¿‡æ»¤å input_df_pred è¡Œæ•°:\", input_df_pred.shape)\n",
    "print(\"ğŸ“Œ player_to_predict åˆ†å¸ƒ:\")\n",
    "print(input_df_pred[\"player_to_predict\"].value_counts())\n",
    "\n",
    "# æ£€æŸ¥å”¯ä¸€çš„ play_direction åˆ†å¸ƒ\n",
    "print(\"\\nğŸ“Œ play_direction(after filtering) åˆ†å¸ƒ:\")\n",
    "print(input_df_pred[\"play_direction\"].value_counts())\n",
    "\n",
    "# æ‰“å°å‰ 5 è¡Œç¡®è®¤ç»“æ„\n",
    "print(\"\\nğŸ“Œ è¿‡æ»¤åçš„å‰5è¡Œ:\")\n",
    "print(input_df_pred.head())\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 9,
   "id": "fe770a62",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T02:58:40.808913Z",
     "iopub.status.busy": "2025-11-27T02:58:40.808674Z",
     "iopub.status.idle": "2025-11-27T02:58:41.391533Z",
     "shell.execute_reply": "2025-11-27T02:58:41.390799Z"
    },
    "papermill": {
     "duration": 0.590827,
     "end_time": "2025-11-27T02:58:41.392715",
     "exception": false,
     "start_time": "2025-11-27T02:58:40.801888",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "ğŸ“Œ input æ€» key æ•°: 46045\n",
      "ğŸ“Œ output æ€» key æ•°: 46045\n",
      "ğŸ“Œ input ä¸­æ— æ³•åŒ¹é…åˆ° output çš„ key æ•°: 0\n"
     ]
    }
   ],
   "source": [
    "# ========== Step 3Bï¼šæ£€æŸ¥è¾“å…¥å’Œè¾“å‡ºèƒ½å¦æ­£ç¡®åŒ¹é… ==========\n",
    "\n",
    "# 1) å»ºç«‹ input çš„ key set\n",
    "input_keys = set(zip(\n",
    "    input_df_pred[\"game_id\"],\n",
    "    input_df_pred[\"play_id\"],\n",
    "    input_df_pred[\"nfl_id\"]\n",
    "))\n",
    "\n",
    "# 2) å»ºç«‹ output çš„ key set\n",
    "output_keys = set(zip(\n",
    "    output_df[\"game_id\"],\n",
    "    output_df[\"play_id\"],\n",
    "    output_df[\"nfl_id\"]\n",
    "))\n",
    "\n",
    "# 3) æ‰¾æ²¡æœ‰ output çš„ key\n",
    "keys_missing_output = input_keys - output_keys\n",
    "\n",
    "print(\"ğŸ“Œ input æ€» key æ•°:\", len(input_keys))\n",
    "print(\"ğŸ“Œ output æ€» key æ•°:\", len(output_keys))\n",
    "print(\"ğŸ“Œ input ä¸­æ— æ³•åŒ¹é…åˆ° output çš„ key æ•°:\", len(keys_missing_output))\n",
    "\n",
    "# æŸ¥çœ‹ç¤ºä¾‹ï¼ˆå¦‚æœæœ‰ï¼‰\n",
    "if len(keys_missing_output) > 0:\n",
    "    print(\"\\nğŸ“Œ ç¤ºä¾‹ missing key å‰ 5 ä¸ª:\")\n",
    "    print(list(keys_missing_output)[:5])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 10,
   "id": "41d3e6bc",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T02:58:41.404933Z",
     "iopub.status.busy": "2025-11-27T02:58:41.404270Z",
     "iopub.status.idle": "2025-11-27T02:58:41.414716Z",
     "shell.execute_reply": "2025-11-27T02:58:41.413961Z"
    },
    "papermill": {
     "duration": 0.017658,
     "end_time": "2025-11-27T02:58:41.415869",
     "exception": false,
     "start_time": "2025-11-27T02:58:41.398211",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# ==========================\n",
    "# Step 3C â€” Sequence Builder\n",
    "# ==========================\n",
    "\n",
    "def build_sequences(input_df, output_df, feature_cols, T_in, T_out):\n",
    "    print(\"ğŸ“Œ å¼€å§‹æ„å»ºè®­ç»ƒåºåˆ—...\")\n",
    "\n",
    "    X_list = []\n",
    "    Y_list = []\n",
    "    M_list = []\n",
    "    key_list = []\n",
    "\n",
    "    # group input & output\n",
    "    in_group = input_df.groupby([\"game_id\", \"play_id\", \"nfl_id\"])\n",
    "    out_group = output_df.groupby([\"game_id\", \"play_id\", \"nfl_id\"])\n",
    "\n",
    "    dropped_no_output = 0\n",
    "    len_out_counter = {}\n",
    "\n",
    "    for key, df_in in in_group:\n",
    "        if key not in out_group.groups:\n",
    "            dropped_no_output += 1\n",
    "            continue\n",
    "        \n",
    "        df_out = out_group.get_group(key)\n",
    "\n",
    "        # sort by frame_id\n",
    "        df_in = df_in.sort_values(\"frame_id\")\n",
    "        df_out = df_out.sort_values(\"frame_id\")\n",
    "\n",
    "        # ==========================\n",
    "        # X_seqï¼ˆè¾“å…¥ 32 å¸§ï¼‰\n",
    "        # ==========================\n",
    "        in_feats = df_in[feature_cols].values.astype(np.float32)\n",
    "        L_in = in_feats.shape[0]\n",
    "\n",
    "        if L_in >= T_in:\n",
    "            X_seq = in_feats[-T_in:]\n",
    "        else:\n",
    "            pad = np.zeros((T_in - L_in, len(feature_cols)), dtype=np.float32)\n",
    "            X_seq = np.concatenate([pad, in_feats], axis=0)\n",
    "\n",
    "        # ==========================\n",
    "        # Y_seqï¼ˆè¾“å‡º 21 å¸§ï¼‰\n",
    "        # ==========================\n",
    "        out_xy = df_out[[\"x\", \"y\"]].values.astype(np.float32)\n",
    "        L_out = out_xy.shape[0]\n",
    "\n",
    "        len_out_counter[L_out] = len_out_counter.get(L_out, 0) + 1\n",
    "\n",
    "        if L_out == 0:\n",
    "            dropped_no_output += 1\n",
    "            continue\n",
    "\n",
    "        if L_out >= T_out:\n",
    "            Y_seq = out_xy[:T_out]\n",
    "            mask = np.ones(T_out, dtype=np.float32)\n",
    "        else:\n",
    "            # pad last position\n",
    "            last_xy = out_xy[-1]\n",
    "            pad_xy = np.tile(last_xy, (T_out - L_out, 1))\n",
    "            Y_seq = np.vstack([out_xy, pad_xy])\n",
    "            mask = np.concatenate([\n",
    "                np.ones(L_out, dtype=np.float32),\n",
    "                np.zeros(T_out - L_out, dtype=np.float32)\n",
    "            ])\n",
    "\n",
    "        X_list.append(X_seq)\n",
    "        Y_list.append(Y_seq)\n",
    "        M_list.append(mask)\n",
    "        key_list.append(key)\n",
    "\n",
    "    # convert to numpy\n",
    "    X_all = np.stack(X_list)\n",
    "    Y_all = np.stack(Y_list)\n",
    "    M_all = np.stack(M_list)\n",
    "\n",
    "    # ========= è¾“å‡ºéªŒè¯ =========\n",
    "    print(\"âœ… æ„å»ºå®Œæˆ\")\n",
    "    print(\"\\nğŸ“Œ key æ•°:\", len(key_list))\n",
    "    print(\"ğŸ“Œ X_all.shape:\", X_all.shape)\n",
    "    print(\"ğŸ“Œ Y_all.shape:\", Y_all.shape)\n",
    "    print(\"ğŸ“Œ M_all.shape:\", M_all.shape)\n",
    "\n",
    "    print(\"\\nğŸ“Œ ç¬¬ 1 ä¸ªæ ·æœ¬ X å‰ 3 è¡Œï¼š\")\n",
    "    print(X_all[0][:3])\n",
    "\n",
    "    print(\"\\nğŸ“Œ ç¬¬ 1 ä¸ªæ ·æœ¬ Yï¼ˆæœªæ¥åæ ‡ï¼‰å‰ 3 è¡Œï¼š\")\n",
    "    print(Y_all[0][:3])\n",
    "\n",
    "    print(\"\\nğŸ“Œ ç¬¬ 1 ä¸ªæ ·æœ¬ maskï¼š\")\n",
    "    print(M_all[0])\n",
    "\n",
    "    print(\"\\nğŸ“Œ å„ L_out åˆ†å¸ƒï¼ˆè¾“å‡ºå¸§æ•°é‡ç»Ÿè®¡ï¼‰:\")\n",
    "    for L, cnt in sorted(len_out_counter.items()):\n",
    "        print(f\"  L_out={L}:  {cnt}\")\n",
    "\n",
    "    print(\"\\nğŸ“Œ æ— è¾“å‡ºå¸§çš„ key æ•°:\", dropped_no_output)\n",
    "\n",
    "    return X_all, Y_all, M_all, key_list\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 11,
   "id": "6fb61b0a",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T02:58:41.427241Z",
     "iopub.status.busy": "2025-11-27T02:58:41.427047Z",
     "iopub.status.idle": "2025-11-27T02:59:41.285355Z",
     "shell.execute_reply": "2025-11-27T02:59:41.284548Z"
    },
    "papermill": {
     "duration": 59.871345,
     "end_time": "2025-11-27T02:59:41.292429",
     "exception": false,
     "start_time": "2025-11-27T02:58:41.421084",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "ğŸ“Œ å¼€å§‹æ„å»ºè®­ç»ƒåºåˆ—...\n",
      "âœ… æ„å»ºå®Œæˆ\n",
      "\n",
      "ğŸ“Œ key æ•°: 46045\n",
      "ğŸ“Œ X_all.shape: (46045, 32, 18)\n",
      "ğŸ“Œ Y_all.shape: (46045, 21, 2)\n",
      "ğŸ“Œ M_all.shape: (46045, 21)\n",
      "\n",
      "ğŸ“Œ ç¬¬ 1 ä¸ªæ ·æœ¬ X å‰ 3 è¡Œï¼š\n",
      "[[0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]\n",
      " [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]\n",
      " [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]]\n",
      "\n",
      "ğŸ“Œ ç¬¬ 1 ä¸ªæ ·æœ¬ Yï¼ˆæœªæ¥åæ ‡ï¼‰å‰ 3 è¡Œï¼š\n",
      "[[53.2  13.98]\n",
      " [53.96 13.78]\n",
      " [54.7  13.54]]\n",
      "\n",
      "ğŸ“Œ ç¬¬ 1 ä¸ªæ ·æœ¬ maskï¼š\n",
      "[1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1. 1.]\n",
      "\n",
      "ğŸ“Œ å„ L_out åˆ†å¸ƒï¼ˆè¾“å‡ºå¸§æ•°é‡ç»Ÿè®¡ï¼‰:\n",
      "  L_out=5:  254\n",
      "  L_out=6:  1749\n",
      "  L_out=7:  4600\n",
      "  L_out=8:  5774\n",
      "  L_out=9:  5441\n",
      "  L_out=10:  5116\n",
      "  L_out=11:  3915\n",
      "  L_out=12:  3184\n",
      "  L_out=13:  2644\n",
      "  L_out=14:  2098\n",
      "  L_out=15:  1696\n",
      "  L_out=16:  1444\n",
      "  L_out=17:  1135\n",
      "  L_out=18:  1019\n",
      "  L_out=19:  782\n",
      "  L_out=20:  769\n",
      "  L_out=21:  628\n",
      "  L_out=22:  598\n",
      "  L_out=23:  590\n",
      "  L_out=24:  505\n",
      "  L_out=25:  376\n",
      "  L_out=26:  342\n",
      "  L_out=27:  362\n",
      "  L_out=28:  320\n",
      "  L_out=29:  294\n",
      "  L_out=30:  111\n",
      "  L_out=31:  141\n",
      "  L_out=32:  56\n",
      "  L_out=33:  42\n",
      "  L_out=34:  27\n",
      "  L_out=36:  10\n",
      "  L_out=40:  7\n",
      "  L_out=55:  8\n",
      "  L_out=94:  8\n",
      "\n",
      "ğŸ“Œ æ— è¾“å‡ºå¸§çš„ key æ•°: 0\n"
     ]
    }
   ],
   "source": [
    "# ====== æ‰§è¡Œ Step 3C ======\n",
    "X_all, Y_all, M_all, keys = build_sequences(\n",
    "    input_df_pred,\n",
    "    output_df,\n",
    "    CFG.FEATURE_COLS,\n",
    "    CFG.T_IN,\n",
    "    CFG.T_OUT\n",
    ")"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 12,
   "id": "0e419a47",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T02:59:41.304395Z",
     "iopub.status.busy": "2025-11-27T02:59:41.304134Z",
     "iopub.status.idle": "2025-11-27T02:59:41.354570Z",
     "shell.execute_reply": "2025-11-27T02:59:41.353608Z"
    },
    "papermill": {
     "duration": 0.057913,
     "end_time": "2025-11-27T02:59:41.355818",
     "exception": false,
     "start_time": "2025-11-27T02:59:41.297905",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "æ€»æ ·æœ¬æ•° N = 46045\n",
      "\n",
      "ğŸ“Œ Train/Val åˆ†å¸ƒï¼š\n",
      "Train size: (36836, 32, 18)\n",
      "Val size:   (9209, 32, 18)\n",
      "\n",
      "ğŸ“Œ éªŒè¯ Y_train å‰ 3 è¡Œï¼š\n",
      "[[53.46 38.1 ]\n",
      " [53.52 38.04]\n",
      " [53.54 38.  ]]\n",
      "\n",
      "ğŸ“Œ éªŒè¯ M_train å‰ 10 ä½ï¼š\n",
      "[1. 1. 1. 1. 1. 1. 1. 0. 0. 0.]\n"
     ]
    }
   ],
   "source": [
    "# ========== Step 4A: Train/Val Split ==========\n",
    "\n",
    "N = X_all.shape[0]\n",
    "print(\"æ€»æ ·æœ¬æ•° N =\", N)\n",
    "\n",
    "rng = np.random.default_rng(42)  # å¯å¤ç°\n",
    "perm = rng.permutation(N)\n",
    "\n",
    "split = int(N * 0.8)\n",
    "train_idx = perm[:split]\n",
    "val_idx   = perm[split:]\n",
    "\n",
    "X_train = X_all[train_idx]\n",
    "Y_train = Y_all[train_idx]\n",
    "M_train = M_all[train_idx]\n",
    "\n",
    "X_val = X_all[val_idx]\n",
    "Y_val = Y_all[val_idx]\n",
    "M_val = M_all[val_idx]\n",
    "\n",
    "print(\"\\nğŸ“Œ Train/Val åˆ†å¸ƒï¼š\")\n",
    "print(\"Train size:\", X_train.shape)\n",
    "print(\"Val size:  \", X_val.shape)\n",
    "\n",
    "# éªŒè¯ Train/Val æ˜¯å¦æ­£ç¡®\n",
    "print(\"\\nğŸ“Œ éªŒè¯ Y_train å‰ 3 è¡Œï¼š\")\n",
    "print(Y_train[0][:3])\n",
    "\n",
    "print(\"\\nğŸ“Œ éªŒè¯ M_train å‰ 10 ä½ï¼š\")\n",
    "print(M_train[0][:10])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 13,
   "id": "d8f95865",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T02:59:41.368315Z",
     "iopub.status.busy": "2025-11-27T02:59:41.368071Z",
     "iopub.status.idle": "2025-11-27T02:59:44.758803Z",
     "shell.execute_reply": "2025-11-27T02:59:44.757833Z"
    },
    "papermill": {
     "duration": 3.398228,
     "end_time": "2025-11-27T02:59:44.760005",
     "exception": false,
     "start_time": "2025-11-27T02:59:41.361777",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "ğŸ“Œ batch xb.shape = torch.Size([128, 32, 18])\n",
      "ğŸ“Œ batch yb.shape = torch.Size([128, 21, 2])\n",
      "ğŸ“Œ batch mb.shape = torch.Size([128, 21])\n",
      "ğŸ“Œ batch xb.shape = torch.Size([128, 32, 18])\n",
      "ğŸ“Œ batch yb.shape = torch.Size([128, 21, 2])\n",
      "ğŸ“Œ batch mb.shape = torch.Size([128, 21])\n"
     ]
    }
   ],
   "source": [
    "# ========== Step 4B: DataLoader æ„å»º ==========\n",
    "\n",
    "import torch\n",
    "from torch.utils.data import Dataset, DataLoader\n",
    "\n",
    "class SeqDataset(Dataset):\n",
    "    def __init__(self, X, Y, M):\n",
    "        self.X = torch.from_numpy(X).float()\n",
    "        self.Y = torch.from_numpy(Y).float()\n",
    "        self.M = torch.from_numpy(M).float()\n",
    "\n",
    "    def __len__(self):\n",
    "        return len(self.X)\n",
    "\n",
    "    def __getitem__(self, idx):\n",
    "        return self.X[idx], self.Y[idx], self.M[idx]\n",
    "\n",
    "\n",
    "def build_loader(X, Y, M, batch_size=CFG.BATCH_SIZE, shuffle=True):\n",
    "    dataset = SeqDataset(X, Y, M)\n",
    "    loader = DataLoader(dataset, batch_size=batch_size,\n",
    "                        shuffle=shuffle, drop_last=False)\n",
    "\n",
    "    # æ‰“å°ç¬¬ä¸€ä¸ª batch çš„ç»´åº¦éªŒè¯\n",
    "    for xb, yb, mb in loader:\n",
    "        print(\"ğŸ“Œ batch xb.shape =\", xb.shape)  # [B, 32, 18]\n",
    "        print(\"ğŸ“Œ batch yb.shape =\", yb.shape)  # [B, 21, 2]\n",
    "        print(\"ğŸ“Œ batch mb.shape =\", mb.shape)  # [B, 21]\n",
    "        break\n",
    "\n",
    "    return loader\n",
    "\n",
    "\n",
    "# æ„å»º Loaders\n",
    "train_loader = build_loader(X_train, Y_train, M_train, shuffle=True)\n",
    "val_loader   = build_loader(X_val,   Y_val,   M_val,   shuffle=False)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 14,
   "id": "c826c9cd",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T02:59:44.772711Z",
     "iopub.status.busy": "2025-11-27T02:59:44.772171Z",
     "iopub.status.idle": "2025-11-27T02:59:44.782814Z",
     "shell.execute_reply": "2025-11-27T02:59:44.782231Z"
    },
    "papermill": {
     "duration": 0.018107,
     "end_time": "2025-11-27T02:59:44.783976",
     "exception": false,
     "start_time": "2025-11-27T02:59:44.765869",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# ========== Step 5A: æ„å»º Transformer æ¨¡å‹ï¼ˆåŸºç¡€æ¶æ„ï¼‰ ==========\n",
    "\n",
    "import torch\n",
    "import torch.nn as nn\n",
    "import math\n",
    "\n",
    "# ä½ç½®ç¼–ç \n",
    "class PositionalEncoding(nn.Module):\n",
    "    def __init__(self, d_model, max_len=64):\n",
    "        super().__init__()\n",
    "        pe = torch.zeros(max_len, d_model)\n",
    "        position = torch.arange(0, max_len, dtype=torch.float32).unsqueeze(1)\n",
    "        div_term = torch.exp(\n",
    "            torch.arange(0, d_model, 2).float() * (-math.log(10000.0) / d_model)\n",
    "        )\n",
    "        pe[:, 0::2] = torch.sin(position * div_term)\n",
    "        pe[:, 1::2] = torch.cos(position * div_term)\n",
    "        self.register_buffer('pe', pe.unsqueeze(0))  # [1, max_len, d_model]\n",
    "\n",
    "    def forward(self, x):\n",
    "        # x: [B, T, d_model]\n",
    "        return x + self.pe[:, :x.size(1)]\n",
    "\n",
    "\n",
    "# ===== Autoregressive Transformer =====\n",
    "class AutoRegressiveTransformer(nn.Module):\n",
    "    def __init__(self,\n",
    "                 input_dim,\n",
    "                 d_model=CFG.D_MODEL,\n",
    "                 nhead=CFG.NHEAD,\n",
    "                 num_layers=CFG.NUM_LAYERS,\n",
    "                 T_in=CFG.T_IN,\n",
    "                 T_out=CFG.T_OUT):\n",
    "        super().__init__()\n",
    "\n",
    "        self.T_out = T_out\n",
    "\n",
    "        # input projection: 18 â†’ d_model\n",
    "        self.input_fc = nn.Linear(input_dim, d_model)\n",
    "\n",
    "        # positional encoding\n",
    "        self.pos_encoder = PositionalEncoding(d_model, max_len=T_in + T_out)\n",
    "\n",
    "        # encoder\n",
    "        enc_layer = nn.TransformerEncoderLayer(\n",
    "            d_model=d_model,\n",
    "            nhead=nhead,\n",
    "            dim_feedforward=d_model * 4,\n",
    "            batch_first=True\n",
    "        )\n",
    "        self.encoder = nn.TransformerEncoder(enc_layer, num_layers=num_layers)\n",
    "\n",
    "        # decoder\n",
    "        dec_layer = nn.TransformerDecoderLayer(\n",
    "            d_model=d_model,\n",
    "            nhead=nhead,\n",
    "            dim_feedforward=d_model * 4,\n",
    "            batch_first=True\n",
    "        )\n",
    "        self.decoder = nn.TransformerDecoder(dec_layer, num_layers=num_layers)\n",
    "\n",
    "        # decoder query projection: 2 â†’ d_model\n",
    "        self.query_fc = nn.Linear(2, d_model)\n",
    "\n",
    "        # output projection: d_model â†’ 2\n",
    "        self.out_fc = nn.Linear(d_model, 2)\n",
    "\n",
    "    # ç”Ÿæˆ causal maskï¼ˆprevent seeing the futureï¼‰\n",
    "    def _generate_square_subsequent_mask(self, size, device):\n",
    "        return torch.triu(\n",
    "            torch.full((size, size), float('-inf'), device=device),\n",
    "            diagonal=1\n",
    "        )\n",
    "        \n",
    "    def forward(self, src):\n",
    "        B = src.size(0)\n",
    "        device = src.device\n",
    "    \n",
    "        # Encoder\n",
    "        src_emb = self.input_fc(src)\n",
    "        src_emb = self.pos_encoder(src_emb)\n",
    "        memory = self.encoder(src_emb)\n",
    "    \n",
    "        # Autoregressive decoding\n",
    "        outputs = []\n",
    "        last_pos = src[:, -1, :2]  # åˆå§‹ç‚¹\n",
    "    \n",
    "        dec_inputs = last_pos.unsqueeze(1)  # [B,1,2]\n",
    "    \n",
    "        for t in range(self.T_out):\n",
    "            # ä½ç½®ç¼–ç \n",
    "            dec_emb = self.query_fc(dec_inputs)\n",
    "            dec_emb = self.pos_encoder(dec_emb)\n",
    "    \n",
    "            T_current = dec_emb.size(1)\n",
    "            tgt_mask = self._generate_square_subsequent_mask(T_current, device)\n",
    "    \n",
    "            dec_output = self.decoder(\n",
    "                tgt=dec_emb,\n",
    "                memory=memory,\n",
    "                tgt_mask=tgt_mask\n",
    "            )\n",
    "    \n",
    "            out_t = self.out_fc(dec_output[:, -1, :])\n",
    "            outputs.append(out_t)\n",
    "    \n",
    "            # å°†å½“å‰è¾“å‡º append åˆ° sequence\n",
    "            dec_inputs = torch.cat([dec_inputs, out_t.unsqueeze(1)], dim=1)\n",
    "    \n",
    "        outputs = torch.stack(outputs, dim=1)  # [B,21,2]\n",
    "        return outputs\n",
    "\n",
    "\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 15,
   "id": "c96ab409",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T02:59:44.795959Z",
     "iopub.status.busy": "2025-11-27T02:59:44.795582Z",
     "iopub.status.idle": "2025-11-27T02:59:46.845257Z",
     "shell.execute_reply": "2025-11-27T02:59:46.844292Z"
    },
    "papermill": {
     "duration": 2.056933,
     "end_time": "2025-11-27T02:59:46.846559",
     "exception": false,
     "start_time": "2025-11-27T02:59:44.789626",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "ğŸ“Œ forward() å·²æ›´æ–°ï¼Œå‡†å¤‡æµ‹è¯•æ¨¡å‹è¾“å‡º...\n",
      "ğŸ“Œ preds.shape = torch.Size([128, 21, 2])\n"
     ]
    }
   ],
   "source": [
    "# å®ä¾‹åŒ–æ¨¡å‹\n",
    "model = AutoRegressiveTransformer(\n",
    "    input_dim=len(CFG.FEATURE_COLS),\n",
    "    d_model=CFG.D_MODEL,\n",
    "    nhead=CFG.NHEAD,\n",
    "    num_layers=CFG.NUM_LAYERS,\n",
    "    T_in=CFG.T_IN,\n",
    "    T_out=CFG.T_OUT\n",
    ")\n",
    "\n",
    "\n",
    "print(\"ğŸ“Œ forward() å·²æ›´æ–°ï¼Œå‡†å¤‡æµ‹è¯•æ¨¡å‹è¾“å‡º...\")\n",
    "\n",
    "# ä» train_loader å–ä¸€ä¸ª batch\n",
    "xb, yb, mb = next(iter(train_loader))\n",
    "xb = xb.float()\n",
    "\n",
    "with torch.no_grad():\n",
    "    preds = model(xb)\n",
    "\n",
    "print(\"ğŸ“Œ preds.shape =\", preds.shape)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 16,
   "id": "58c383de",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T02:59:46.862044Z",
     "iopub.status.busy": "2025-11-27T02:59:46.861474Z",
     "iopub.status.idle": "2025-11-27T02:59:51.362820Z",
     "shell.execute_reply": "2025-11-27T02:59:51.362224Z"
    },
    "papermill": {
     "duration": 4.510086,
     "end_time": "2025-11-27T02:59:51.364158",
     "exception": false,
     "start_time": "2025-11-27T02:59:46.854072",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "# ========== Step 6A: è®­ç»ƒä¸éªŒè¯å‡½æ•° ==========\n",
    "\n",
    "import torch\n",
    "import torch.nn.functional as F\n",
    "import math\n",
    "\n",
    "device = torch.device(\"cuda\" if torch.cuda.is_available() else \"cpu\")\n",
    "model = model.to(device)\n",
    "\n",
    "optimizer = torch.optim.Adam(model.parameters(), lr=CFG.LR)\n",
    "\n",
    "\n",
    "# ----------- è®­ç»ƒä¸€ä¸ª epoch ----------\n",
    "def train_one_epoch(model, loader, optimizer, clip_grad=1.0):\n",
    "    model.train()\n",
    "    total_loss = 0\n",
    "    count = 0\n",
    "\n",
    "    for xb, yb, mb in loader:\n",
    "        xb = xb.to(device)\n",
    "        yb = yb.to(device)\n",
    "        mb = mb.to(device)\n",
    "\n",
    "        optimizer.zero_grad()\n",
    "\n",
    "        preds_rel = model(xb)                  # [B,21,2]\n",
    "        last_pos = xb[:, -1, :2]               # [B,2]\n",
    "        preds_abs = preds_rel + last_pos.unsqueeze(1)\n",
    "\n",
    "        diff = (preds_abs - yb) * mb.unsqueeze(-1)\n",
    "        se = (diff ** 2).sum()\n",
    "        cnt = (mb.sum() * 2.0)\n",
    "\n",
    "        loss = se / cnt\n",
    "        loss.backward()\n",
    "\n",
    "        if clip_grad:\n",
    "            torch.nn.utils.clip_grad_norm_(model.parameters(), clip_grad)\n",
    "\n",
    "        optimizer.step()\n",
    "\n",
    "        total_loss += loss.item()\n",
    "        count += 1\n",
    "\n",
    "    return total_loss / count\n",
    "\n",
    "\n",
    "# ----------- éªŒè¯ RMSE -----------\n",
    "def compute_rmse(model, loader):\n",
    "    model.eval()\n",
    "    se_sum = 0.0\n",
    "    n_sum = 0.0\n",
    "\n",
    "    with torch.no_grad():\n",
    "        for xb, yb, mb in loader:\n",
    "            xb = xb.to(device)\n",
    "            yb = yb.to(device)\n",
    "            mb = mb.to(device)\n",
    "\n",
    "            preds_rel = model(xb)\n",
    "            last_pos = xb[:, -1, :2]\n",
    "            preds_abs = preds_rel + last_pos.unsqueeze(1)\n",
    "\n",
    "            diff = (preds_abs - yb) * mb.unsqueeze(-1)\n",
    "            dist2 = diff[...,0]**2 + diff[...,1]**2\n",
    "\n",
    "            se_sum += dist2.sum().item()\n",
    "            n_sum += mb.sum().item()\n",
    "\n",
    "    rmse = math.sqrt(se_sum / n_sum)\n",
    "    return rmse\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 17,
   "id": "8729d872",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T02:59:51.377135Z",
     "iopub.status.busy": "2025-11-27T02:59:51.376625Z",
     "iopub.status.idle": "2025-11-27T03:29:28.706040Z",
     "shell.execute_reply": "2025-11-27T03:29:28.705311Z"
    },
    "papermill": {
     "duration": 1777.343469,
     "end_time": "2025-11-27T03:29:28.713799",
     "exception": false,
     "start_time": "2025-11-27T02:59:51.370330",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Epoch 1/12  | Train Loss = 443.1689  | Val RMSE = 23.9169\n",
      "  ğŸ”¥ æ–°æœ€ä½³æ¨¡å‹å·²ä¿å­˜ï¼\n",
      "Epoch 2/12  | Train Loss = 213.3760  | Val RMSE = 15.5914\n",
      "  ğŸ”¥ æ–°æœ€ä½³æ¨¡å‹å·²ä¿å­˜ï¼\n",
      "Epoch 3/12  | Train Loss = 90.7674  | Val RMSE = 10.2757\n",
      "  ğŸ”¥ æ–°æœ€ä½³æ¨¡å‹å·²ä¿å­˜ï¼\n",
      "Epoch 4/12  | Train Loss = 45.1789  | Val RMSE = 8.0893\n",
      "  ğŸ”¥ æ–°æœ€ä½³æ¨¡å‹å·²ä¿å­˜ï¼\n",
      "Epoch 5/12  | Train Loss = 27.8634  | Val RMSE = 6.9393\n",
      "  ğŸ”¥ æ–°æœ€ä½³æ¨¡å‹å·²ä¿å­˜ï¼\n",
      "Epoch 6/12  | Train Loss = 19.6763  | Val RMSE = 6.4402\n",
      "  ğŸ”¥ æ–°æœ€ä½³æ¨¡å‹å·²ä¿å­˜ï¼\n",
      "Epoch 7/12  | Train Loss = 16.9257  | Val RMSE = 5.2153\n",
      "  ğŸ”¥ æ–°æœ€ä½³æ¨¡å‹å·²ä¿å­˜ï¼\n",
      "Epoch 8/12  | Train Loss = 14.4068  | Val RMSE = 4.5281\n",
      "  ğŸ”¥ æ–°æœ€ä½³æ¨¡å‹å·²ä¿å­˜ï¼\n",
      "Epoch 9/12  | Train Loss = 13.7109  | Val RMSE = 4.4343\n",
      "  ğŸ”¥ æ–°æœ€ä½³æ¨¡å‹å·²ä¿å­˜ï¼\n",
      "Epoch 10/12  | Train Loss = 11.2477  | Val RMSE = 4.5127\n",
      "Epoch 11/12  | Train Loss = 10.3090  | Val RMSE = 4.4821\n",
      "Epoch 12/12  | Train Loss = 9.1893  | Val RMSE = 3.9955\n",
      "  ğŸ”¥ æ–°æœ€ä½³æ¨¡å‹å·²ä¿å­˜ï¼\n",
      "\n",
      "è®­ç»ƒå®Œæˆï¼æœ€ä½³ Val RMSE = 3.995465155862596\n"
     ]
    }
   ],
   "source": [
    "# ========== Step 6B: æ­£å¼è®­ç»ƒæ¨¡å‹ ==========\n",
    "\n",
    "best_rmse = float(\"inf\")\n",
    "\n",
    "for epoch in range(1, CFG.EPOCHS + 1):\n",
    "    train_loss = train_one_epoch(model, train_loader, optimizer)\n",
    "\n",
    "    val_rmse = compute_rmse(model, val_loader)\n",
    "\n",
    "    print(f\"Epoch {epoch}/{CFG.EPOCHS}  | Train Loss = {train_loss:.4f}  | Val RMSE = {val_rmse:.4f}\")\n",
    "\n",
    "    if val_rmse < best_rmse:\n",
    "        best_rmse = val_rmse\n",
    "        torch.save(model.state_dict(), CFG.MODEL_SAVE_PATH)\n",
    "        print(\"  ğŸ”¥ æ–°æœ€ä½³æ¨¡å‹å·²ä¿å­˜ï¼\")\n",
    "\n",
    "\n",
    "print(\"\\nè®­ç»ƒå®Œæˆï¼æœ€ä½³ Val RMSE =\", best_rmse)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 18,
   "id": "addf5f81",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T03:29:28.727173Z",
     "iopub.status.busy": "2025-11-27T03:29:28.726526Z",
     "iopub.status.idle": "2025-11-27T03:29:28.947775Z",
     "shell.execute_reply": "2025-11-27T03:29:28.946784Z"
    },
    "papermill": {
     "duration": 0.228921,
     "end_time": "2025-11-27T03:29:28.948916",
     "exception": false,
     "start_time": "2025-11-27T03:29:28.719995",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "ğŸ“Œ Loading test_input.csv ...\n",
      "test_input_df shape: (49753, 23)\n",
      "\n",
      "ğŸ“Œ Loading test.csv ...\n",
      "test_df shape: (5837, 5)\n",
      "\n",
      "ğŸ“Œ test_input_df å‰ 5 è¡Œï¼š\n",
      "      game_id  play_id  player_to_predict  nfl_id  frame_id play_direction  absolute_yardline_number    player_name player_height  player_weight player_birth_date player_position player_side  \\\n",
      "0  2024120805       74              False   52518         1           left                        95  Darnay Holmes          5-10            198        1998-06-23              CB     Defense   \n",
      "1  2024120805       74              False   52518         2           left                        95  Darnay Holmes          5-10            198        1998-06-23              CB     Defense   \n",
      "2  2024120805       74              False   52518         3           left                        95  Darnay Holmes          5-10            198        1998-06-23              CB     Defense   \n",
      "3  2024120805       74              False   52518         4           left                        95  Darnay Holmes          5-10            198        1998-06-23              CB     Defense   \n",
      "4  2024120805       74              False   52518         5           left                        95  Darnay Holmes          5-10            198        1998-06-23              CB     Defense   \n",
      "\n",
      "          player_role      x      y     s     a     dir      o  num_frames_output  ball_land_x  ball_land_y  \n",
      "0  Defensive Coverage  90.85  17.17  0.35  0.78  218.39  81.52                 11    90.379997    46.470001  \n",
      "1  Defensive Coverage  90.83  17.11  0.62  1.20  204.64  81.52                 11    90.379997    46.470001  \n",
      "2  Defensive Coverage  90.80  17.03  0.87  1.44  200.53  81.52                 11    90.379997    46.470001  \n",
      "3  Defensive Coverage  90.76  16.91  1.22  1.87  197.16  81.52                 11    90.379997    46.470001  \n",
      "4  Defensive Coverage  90.72  16.77  1.52  2.11  195.24  83.75                 11    90.379997    46.470001  \n",
      "\n",
      "ğŸ“Œ test_df å‰ 5 è¡Œï¼š\n",
      "      id     game_id  play_id  nfl_id  frame_id\n",
      "0  12350  2024120805       74   54586         1\n",
      "1  12351  2024120805       74   54586         2\n",
      "2  12352  2024120805       74   54586         3\n",
      "3  12353  2024120805       74   54586         4\n",
      "4  12354  2024120805       74   54586         5\n"
     ]
    }
   ],
   "source": [
    "# ========== Step 7A Revised: Load test_input.csv + test.csv ==========\n",
    "\n",
    "import pandas as pd\n",
    "\n",
    "test_input_path = \"/kaggle/input/nfl-big-data-bowl-2026-prediction/test_input.csv\"\n",
    "test_path       = \"/kaggle/input/nfl-big-data-bowl-2026-prediction/test.csv\"\n",
    "\n",
    "print(\"ğŸ“Œ Loading test_input.csv ...\")\n",
    "test_input_df = pd.read_csv(test_input_path)\n",
    "print(\"test_input_df shape:\", test_input_df.shape)\n",
    "\n",
    "print(\"\\nğŸ“Œ Loading test.csv ...\")\n",
    "test_df = pd.read_csv(test_path)\n",
    "print(\"test_df shape:\", test_df.shape)\n",
    "\n",
    "print(\"\\nğŸ“Œ test_input_df å‰ 5 è¡Œï¼š\")\n",
    "print(test_input_df.head())\n",
    "\n",
    "print(\"\\nğŸ“Œ test_df å‰ 5 è¡Œï¼š\")\n",
    "print(test_df.head())\n",
    "\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 19,
   "id": "fc1aa941",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T03:29:28.962958Z",
     "iopub.status.busy": "2025-11-27T03:29:28.962321Z",
     "iopub.status.idle": "2025-11-27T03:29:29.014496Z",
     "shell.execute_reply": "2025-11-27T03:29:29.013502Z"
    },
    "papermill": {
     "duration": 0.060385,
     "end_time": "2025-11-27T03:29:29.015918",
     "exception": false,
     "start_time": "2025-11-27T03:29:28.955533",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "ğŸ“Œ å¼€å§‹å¯¹ test_input_df åšç‰¹å¾å·¥ç¨‹...\n",
      "âœ… test ç‰¹å¾å·¥ç¨‹å®Œæˆï¼\n",
      "\n",
      "ğŸ“Œ ç¼ºå¤±çš„ç‰¹å¾åˆ—: []\n",
      "\n",
      "ğŸ“Œ ç‰¹å¾ NaN æ•°é‡ï¼š\n",
      "x               0\n",
      "y               0\n",
      "s               0\n",
      "a               0\n",
      "dir             0\n",
      "o               0\n",
      "dir_sin         0\n",
      "dir_cos         0\n",
      "o_sin           0\n",
      "o_cos           0\n",
      "vx              0\n",
      "vy              0\n",
      "ball_land_x     0\n",
      "ball_land_y     0\n",
      "rel_x           0\n",
      "rel_y           0\n",
      "dist_to_land    0\n",
      "frame_left      0\n",
      "dtype: int64\n",
      "\n",
      "ğŸ“Œ ç‰¹å¾åçš„å‰ 5 è¡Œï¼š\n",
      "      game_id  play_id  player_to_predict  nfl_id  frame_id play_direction  absolute_yardline_number    player_name player_height  player_weight player_birth_date player_position player_side  \\\n",
      "0  2024120805       74              False   52518         1           left                        95  Darnay Holmes          5-10            198        1998-06-23              CB     Defense   \n",
      "1  2024120805       74              False   52518         2           left                        95  Darnay Holmes          5-10            198        1998-06-23              CB     Defense   \n",
      "2  2024120805       74              False   52518         3           left                        95  Darnay Holmes          5-10            198        1998-06-23              CB     Defense   \n",
      "3  2024120805       74              False   52518         4           left                        95  Darnay Holmes          5-10            198        1998-06-23              CB     Defense   \n",
      "4  2024120805       74              False   52518         5           left                        95  Darnay Holmes          5-10            198        1998-06-23              CB     Defense   \n",
      "\n",
      "          player_role      x      y     s     a     dir      o  num_frames_output  ball_land_x  ball_land_y   dir_sin   dir_cos     o_sin     o_cos        vx        vy      rel_x      rel_y  \\\n",
      "0  Defensive Coverage  29.15  36.13  0.35  0.78  321.61  98.48                 11    90.379997    46.470001 -0.621011  0.783802  0.989067 -0.147464  0.274331 -0.217354  61.229997  10.340001   \n",
      "1  Defensive Coverage  29.17  36.19  0.62  1.20  335.36  98.48                 11    90.379997    46.470001 -0.416915  0.908945  0.989067 -0.147464  0.563546 -0.258488  61.209997  10.280001   \n",
      "2  Defensive Coverage  29.20  36.27  0.87  1.44  339.47  98.48                 11    90.379997    46.470001 -0.350698  0.936489  0.989067 -0.147464  0.814745 -0.305107  61.179997  10.200001   \n",
      "3  Defensive Coverage  29.24  36.39  1.22  1.87  342.84  98.48                 11    90.379997    46.470001 -0.295041  0.955485  0.989067 -0.147464  1.165691 -0.359950  61.139997  10.080001   \n",
      "4  Defensive Coverage  29.28  36.53  1.52  2.11  344.76  96.25                 11    90.379997    46.470001 -0.262863  0.964833  0.994056 -0.108867  1.466546 -0.399551  61.099997   9.940001   \n",
      "\n",
      "   dist_to_land  frame_left  \n",
      "0     62.096926          10  \n",
      "1     62.067239           9  \n",
      "2     62.024448           8  \n",
      "3     61.965359           7  \n",
      "4     61.903257           6  \n"
     ]
    }
   ],
   "source": [
    "# ========== Step 7B: å¯¹ test_input_df åš Phase 1 ç‰¹å¾å·¥ç¨‹ ==========\n",
    "\n",
    "print(\"ğŸ“Œ å¼€å§‹å¯¹ test_input_df åšç‰¹å¾å·¥ç¨‹...\")\n",
    "\n",
    "test_feat_df = normalize_direction(test_input_df)\n",
    "test_feat_df = add_angle_features(test_feat_df)\n",
    "test_feat_df = add_phase1_features(test_feat_df)\n",
    "\n",
    "print(\"âœ… test ç‰¹å¾å·¥ç¨‹å®Œæˆï¼\")\n",
    "\n",
    "# æ£€æŸ¥ç¼ºå¤±åˆ—\n",
    "missing_cols = [c for c in CFG.FEATURE_COLS if c not in test_feat_df.columns]\n",
    "print(\"\\nğŸ“Œ ç¼ºå¤±çš„ç‰¹å¾åˆ—:\", missing_cols)\n",
    "\n",
    "# æ£€æŸ¥ NaN\n",
    "print(\"\\nğŸ“Œ ç‰¹å¾ NaN æ•°é‡ï¼š\")\n",
    "print(test_feat_df[CFG.FEATURE_COLS].isna().sum())\n",
    "\n",
    "# çœ‹ä¸€ä¸‹å‰ 5 è¡Œ\n",
    "print(\"\\nğŸ“Œ ç‰¹å¾åçš„å‰ 5 è¡Œï¼š\")\n",
    "print(test_feat_df.head())\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 20,
   "id": "d34346cb",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T03:29:29.031265Z",
     "iopub.status.busy": "2025-11-27T03:29:29.031047Z",
     "iopub.status.idle": "2025-11-27T03:29:34.890288Z",
     "shell.execute_reply": "2025-11-27T03:29:34.889315Z"
    },
    "papermill": {
     "duration": 5.868305,
     "end_time": "2025-11-27T03:29:34.891706",
     "exception": false,
     "start_time": "2025-11-27T03:29:29.023401",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "ğŸ“Œ å¼€å§‹æ„é€  test åºåˆ—...\n",
      "ğŸ“Œ Test åºåˆ—æ„é€ å®Œæˆï¼\n",
      "X_test.shape = (5837, 32, 18)\n",
      "ç¼ºå¤± key ä¸ªæ•° = 0\n",
      "\n",
      "ğŸ“Œ ç¬¬ 1 æ¡æ ·æœ¬å‰ 3 è¡Œç‰¹å¾ï¼š\n",
      "[[0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]\n",
      " [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]\n",
      " [0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0. 0.]]\n"
     ]
    }
   ],
   "source": [
    "# ========== Step 7C: æ„é€  test è¾“å…¥åºåˆ— X_test ==========\n",
    "\n",
    "from collections import defaultdict\n",
    "import numpy as np\n",
    "\n",
    "print(\"ğŸ“Œ å¼€å§‹æ„é€  test åºåˆ—...\")\n",
    "\n",
    "# æ ¹æ® (game_id, play_id, nfl_id) åˆ†ç»„\n",
    "test_group = test_feat_df.groupby([\"game_id\", \"play_id\", \"nfl_id\"])\n",
    "\n",
    "X_test_list = []\n",
    "test_keys = []  # ç”¨äºå¯¹é½é¡ºåºä¸ test_df\n",
    "\n",
    "missing_count = 0\n",
    "\n",
    "for idx, row in test_df.iterrows():\n",
    "    key = (row[\"game_id\"], row[\"play_id\"], row[\"nfl_id\"])\n",
    "\n",
    "    if key not in test_group.groups:\n",
    "        missing_count += 1\n",
    "        # ç”¨é›¶å¡«å…… 32x18\n",
    "        X_test_list.append(np.zeros((CFG.T_IN, len(CFG.FEATURE_COLS)), dtype=np.float32))\n",
    "        test_keys.append(key)\n",
    "        continue\n",
    "\n",
    "    df_in = test_group.get_group(key).sort_values(\"frame_id\")\n",
    "\n",
    "    feats = df_in[CFG.FEATURE_COLS].values.astype(np.float32)\n",
    "    L_in = feats.shape[0]\n",
    "\n",
    "    if L_in >= CFG.T_IN:\n",
    "        X_seq = feats[-CFG.T_IN:]\n",
    "    else:\n",
    "        pad = np.zeros((CFG.T_IN - L_in, len(CFG.FEATURE_COLS)), dtype=np.float32)\n",
    "        X_seq = np.concatenate([pad, feats], axis=0)\n",
    "\n",
    "    X_test_list.append(X_seq)\n",
    "    test_keys.append(key)\n",
    "\n",
    "X_test = np.stack(X_test_list)\n",
    "\n",
    "print(\"ğŸ“Œ Test åºåˆ—æ„é€ å®Œæˆï¼\")\n",
    "print(\"X_test.shape =\", X_test.shape)\n",
    "print(\"ç¼ºå¤± key ä¸ªæ•° =\", missing_count)\n",
    "\n",
    "print(\"\\nğŸ“Œ ç¬¬ 1 æ¡æ ·æœ¬å‰ 3 è¡Œç‰¹å¾ï¼š\")\n",
    "print(X_test[0][:3])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 21,
   "id": "0887c1a5",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T03:29:34.907117Z",
     "iopub.status.busy": "2025-11-27T03:29:34.906665Z",
     "iopub.status.idle": "2025-11-27T03:29:40.815151Z",
     "shell.execute_reply": "2025-11-27T03:29:40.814241Z"
    },
    "papermill": {
     "duration": 5.917306,
     "end_time": "2025-11-27T03:29:40.816444",
     "exception": false,
     "start_time": "2025-11-27T03:29:34.899138",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "ğŸ“Œ æ¨¡å‹åŠ è½½å®Œæˆï¼Œå¼€å§‹è¿›è¡Œæ¨ç†...\n",
      "ğŸ“Œ æ¨ç†å®Œæˆï¼\n",
      "all_preds.shape = (5837, 21, 2)\n",
      "\n",
      "ğŸ“Œ ç¬¬ 1 æ¡ test æœªæ¥ 3 å¸§ï¼š\n",
      "[[95.53568  36.12682 ]\n",
      " [95.2052   36.884132]\n",
      " [95.0461   37.2045  ]]\n"
     ]
    }
   ],
   "source": [
    "# ========== Step 7D: åŠ è½½æ¨¡å‹ & æ‰¹é‡æ¨ç† ==========\n",
    "\n",
    "import torch\n",
    "model = AutoRegressiveTransformer(\n",
    "    input_dim=len(CFG.FEATURE_COLS),\n",
    "    d_model=CFG.D_MODEL,\n",
    "    nhead=CFG.NHEAD,\n",
    "    num_layers=CFG.NUM_LAYERS,\n",
    "    T_in=CFG.T_IN,\n",
    "    T_out=CFG.T_OUT\n",
    ")\n",
    "\n",
    "device = torch.device(\"cuda\" if torch.cuda.is_available() else \"cpu\")\n",
    "model.load_state_dict(torch.load(CFG.MODEL_SAVE_PATH, map_location=device))\n",
    "model = model.to(device)\n",
    "model.eval()\n",
    "\n",
    "print(\"ğŸ“Œ æ¨¡å‹åŠ è½½å®Œæˆï¼Œå¼€å§‹è¿›è¡Œæ¨ç†...\")\n",
    "\n",
    "# è½¬ä¸º tensor\n",
    "X_test_tensor = torch.from_numpy(X_test).float().to(device)\n",
    "\n",
    "# æ‰¹é‡æ¨ç†\n",
    "batch_size = 256\n",
    "all_preds = []\n",
    "\n",
    "with torch.no_grad():\n",
    "    for i in range(0, len(X_test_tensor), batch_size):\n",
    "        xb = X_test_tensor[i : i + batch_size]\n",
    "        preds_rel = model(xb)                             # [B,21,2]\n",
    "        last_pos = xb[:, -1, :2]                          # [B,2]\n",
    "        preds_abs = preds_rel + last_pos.unsqueeze(1)     # è½¬ä¸ºç»å¯¹åæ ‡\n",
    "        all_preds.append(preds_abs.cpu())\n",
    "\n",
    "all_preds = torch.cat(all_preds, dim=0).numpy()  # [5837,21,2]\n",
    "\n",
    "print(\"ğŸ“Œ æ¨ç†å®Œæˆï¼\")\n",
    "print(\"all_preds.shape =\", all_preds.shape)\n",
    "\n",
    "# æŸ¥çœ‹ç¬¬ 1 ä¸ªæ ·æœ¬çš„å‰ 3 å¸§\n",
    "print(\"\\nğŸ“Œ ç¬¬ 1 æ¡ test æœªæ¥ 3 å¸§ï¼š\")\n",
    "print(all_preds[0][:3])\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 22,
   "id": "fa23531e",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T03:29:40.832570Z",
     "iopub.status.busy": "2025-11-27T03:29:40.831976Z",
     "iopub.status.idle": "2025-11-27T03:29:41.069439Z",
     "shell.execute_reply": "2025-11-27T03:29:41.068708Z"
    },
    "papermill": {
     "duration": 0.246897,
     "end_time": "2025-11-27T03:29:41.070691",
     "exception": false,
     "start_time": "2025-11-27T03:29:40.823794",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "ğŸ“Œ submission DataFrame shape: (5837, 43)\n",
      "\n",
      "ğŸ“Œ submission å‰ 3 è¡Œï¼š\n",
      "      id        x_1       y_1      x_2        y_2        x_3        y_3        x_4        y_4        x_5        y_5        x_6        y_6        x_7        y_7        x_8        y_8        x_9  \\\n",
      "0  12350  95.535683  36.12682  95.2052  36.884132  95.046097  37.204498  94.940422  37.419487  94.860703  37.583916  94.796577  37.718376  94.742546  37.832748  94.695488  37.932114  94.653839   \n",
      "1  12351  95.535683  36.12682  95.2052  36.884132  95.046097  37.204498  94.940422  37.419487  94.860703  37.583916  94.796577  37.718376  94.742546  37.832748  94.695488  37.932114  94.653839   \n",
      "2  12352  95.535683  36.12682  95.2052  36.884132  95.046097  37.204498  94.940422  37.419487  94.860703  37.583916  94.796577  37.718376  94.742546  37.832748  94.695488  37.932114  94.653839   \n",
      "\n",
      "         y_9       x_10       y_10       x_11       y_11      x_12       y_12      x_13       y_13       x_14       y_14       x_15       y_15       x_16       y_16       x_17       y_17       x_18  \\\n",
      "0  38.019127  94.616737  38.096092  94.583801  38.164387  94.55455  38.225883  94.52803  38.282856  94.502914  38.336876  94.478355  38.388878  94.454315  38.438889  94.431221  38.486755  94.409546   \n",
      "1  38.019127  94.616737  38.096092  94.583801  38.164387  94.55455  38.225883  94.52803  38.282856  94.502914  38.336876  94.478355  38.388878  94.454315  38.438889  94.431221  38.486755  94.409546   \n",
      "2  38.019127  94.616737  38.096092  94.583801  38.164387  94.55455  38.225883  94.52803  38.282856  94.502914  38.336876  94.478355  38.388878  94.454315  38.438889  94.431221  38.486755  94.409546   \n",
      "\n",
      "        y_18       x_19       y_19       x_20       y_20       x_21       y_21  \n",
      "0  38.531952  94.389595  38.574333  94.370346  38.614914  94.352913  38.652763  \n",
      "1  38.531952  94.389595  38.574333  94.370346  38.614914  94.352913  38.652763  \n",
      "2  38.531952  94.389595  38.574333  94.370346  38.614914  94.352913  38.652763  \n",
      "\n",
      "ğŸ‰ submission.csv å·²ä¿å­˜åˆ°ï¼š /kaggle/working/submission.csv\n"
     ]
    }
   ],
   "source": [
    "# ========== Step 7E: ç”Ÿæˆ submission.csv ==========\n",
    "\n",
    "import pandas as pd\n",
    "import numpy as np\n",
    "\n",
    "pred_rows = []\n",
    "\n",
    "for i in range(len(test_df)):\n",
    "    # flatten 21x2 â†’ 42 (x1,y1,x2,y2,...)\n",
    "    coords = all_preds[i].reshape(-1)\n",
    "    pred_rows.append(coords)\n",
    "\n",
    "pred_array = np.vstack(pred_rows)   # shape (5837, 42)\n",
    "\n",
    "# æ„é€ åˆ—å\n",
    "cols = []\n",
    "for t in range(1, 22):\n",
    "    cols += [f\"x_{t}\", f\"y_{t}\"]\n",
    "\n",
    "submission = pd.DataFrame(pred_array, columns=cols)\n",
    "submission.insert(0, \"id\", test_df[\"id\"])\n",
    "\n",
    "print(\"ğŸ“Œ submission DataFrame shape:\", submission.shape)\n",
    "print(\"\\nğŸ“Œ submission å‰ 3 è¡Œï¼š\")\n",
    "print(submission.head(3))\n",
    "\n",
    "# ä¿å­˜\n",
    "submission_path = \"/kaggle/working/submission.csv\"\n",
    "submission.to_csv(submission_path, index=False)\n",
    "\n",
    "print(\"\\nğŸ‰ submission.csv å·²ä¿å­˜åˆ°ï¼š\", submission_path)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 23,
   "id": "b7076f59",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T03:29:41.085555Z",
     "iopub.status.busy": "2025-11-27T03:29:41.085325Z",
     "iopub.status.idle": "2025-11-27T03:29:41.745100Z",
     "shell.execute_reply": "2025-11-27T03:29:41.744313Z"
    },
    "papermill": {
     "duration": 0.668788,
     "end_time": "2025-11-27T03:29:41.746309",
     "exception": false,
     "start_time": "2025-11-27T03:29:41.077521",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [
    {
     "name": "stdout",
     "output_type": "stream",
     "text": [
      "Inference model loaded on cuda\n"
     ]
    }
   ],
   "source": [
    "import torch\n",
    "import pandas as pd\n",
    "import polars as pl\n",
    "\n",
    "device = torch.device(\"cuda\" if torch.cuda.is_available() else \"cpu\")\n",
    "\n",
    "# å®ä¾‹åŒ–æ¨¡å‹ï¼ˆç»“æ„è¦å’Œè®­ç»ƒæ—¶å®Œå…¨ä¸€è‡´ï¼‰\n",
    "inference_model = AutoRegressiveTransformer(\n",
    "    input_dim=len(CFG.FEATURE_COLS),\n",
    "    d_model=CFG.D_MODEL,\n",
    "    nhead=CFG.NHEAD,\n",
    "    num_layers=CFG.NUM_LAYERS,\n",
    "    T_in=CFG.T_IN,\n",
    "    T_out=CFG.T_OUT,\n",
    ").to(device)\n",
    "\n",
    "# âš ï¸ è·¯å¾„å…ˆç”¨ä½ åˆšæ‰è®­ç»ƒå¾—åˆ°çš„æ¨¡å‹\n",
    "# æ­£å¼ code submission è¦æ”¹æˆä» /kaggle/input/ä½ çš„æ¨¡å‹dataset/xxx.pt è¯»å–\n",
    "state_dict = torch.load(CFG.MODEL_SAVE_PATH, map_location=device)\n",
    "inference_model.load_state_dict(state_dict)\n",
    "inference_model.eval()\n",
    "\n",
    "print(\"Inference model loaded on\", device)\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 24,
   "id": "0e306100",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T03:29:41.761695Z",
     "iopub.status.busy": "2025-11-27T03:29:41.761005Z",
     "iopub.status.idle": "2025-11-27T03:29:41.770824Z",
     "shell.execute_reply": "2025-11-27T03:29:41.770119Z"
    },
    "papermill": {
     "duration": 0.018307,
     "end_time": "2025-11-27T03:29:41.771880",
     "exception": false,
     "start_time": "2025-11-27T03:29:41.753573",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "def predict(test: pl.DataFrame | pd.DataFrame,\n",
    "            test_input: pl.DataFrame | pd.DataFrame) -> pl.DataFrame | pd.DataFrame:\n",
    "\n",
    "    # --- ç»Ÿä¸€è½¬æˆ pandas æ–¹ä¾¿å¤„ç† ---\n",
    "    original_is_polars = isinstance(test, pl.DataFrame)\n",
    "\n",
    "    if isinstance(test, pl.DataFrame):\n",
    "        test_pd = test.to_pandas()\n",
    "    else:\n",
    "        test_pd = test.copy()\n",
    "\n",
    "    if isinstance(test_input, pl.DataFrame):\n",
    "        test_input_pd = test_input.to_pandas()\n",
    "    else:\n",
    "        test_input_pd = test_input.copy()\n",
    "\n",
    "    # --- å¯¹ test_input åšä¸è®­ç»ƒå®Œå…¨ä¸€è‡´çš„ç‰¹å¾å·¥ç¨‹ ---\n",
    "    feat_df = normalize_direction(test_input_pd)\n",
    "    feat_df = add_angle_features(feat_df)\n",
    "    feat_df = add_phase1_features(feat_df)\n",
    "\n",
    "    # åªä¿ç•™éœ€è¦é¢„æµ‹çš„çƒå‘˜ï¼ˆå…¶å® test é‡Œåªæœ‰è¿™äº›ï¼‰\n",
    "    # ä½†ä¸ºäº†å®‰å…¨ï¼Œæˆ‘ä»¬æŒ‰ (game_id, play_id, nfl_id) åš groupby\n",
    "    group = feat_df.groupby([\"game_id\", \"play_id\", \"nfl_id\"])\n",
    "\n",
    "    X_list = []\n",
    "    missing = 0\n",
    "\n",
    "    for _, row in test_pd.iterrows():\n",
    "        g = row[\"game_id\"]\n",
    "        p = row[\"play_id\"]\n",
    "        n = row[\"nfl_id\"]\n",
    "        frame_id = row[\"frame_id\"]\n",
    "\n",
    "        key = (g, p, n)\n",
    "\n",
    "        if key not in group.groups:\n",
    "            # æç«¯æƒ…å†µï¼šæ²¡æ‰¾åˆ°ï¼Œå°±å…¨é›¶ç‰¹å¾\n",
    "            X_list.append(np.zeros((CFG.T_IN, len(CFG.FEATURE_COLS)), dtype=np.float32))\n",
    "            missing += 1\n",
    "            continue\n",
    "\n",
    "        df_player = group.get_group(key)\n",
    "\n",
    "        # åªç”¨å½“å‰ frame_id åŠä¹‹å‰çš„å¸§ï¼ˆé˜²æ­¢å·çœ‹æœªæ¥ï¼‰\n",
    "        df_player = df_player[df_player[\"frame_id\"] <= frame_id]\n",
    "        df_player = df_player.sort_values(\"frame_id\")\n",
    "\n",
    "        feats = df_player[CFG.FEATURE_COLS].values.astype(np.float32)\n",
    "        L = feats.shape[0]\n",
    "\n",
    "        if L >= CFG.T_IN:\n",
    "            X_seq = feats[-CFG.T_IN:]\n",
    "        else:\n",
    "            pad = np.zeros((CFG.T_IN - L, len(CFG.FEATURE_COLS)), dtype=np.float32)\n",
    "            X_seq = np.concatenate([pad, feats], axis=0)\n",
    "\n",
    "        X_list.append(X_seq)\n",
    "\n",
    "    X_batch = np.stack(X_list)  # [B, 32, 18]\n",
    "\n",
    "    # --- æ¨¡å‹æ¨ç†ï¼Œåªå–ç¬¬ 1 å¸§é¢„æµ‹ ---\n",
    "    xb = torch.from_numpy(X_batch).float().to(device)\n",
    "\n",
    "    with torch.no_grad():\n",
    "        preds_rel = inference_model(xb)       # [B, 21, 2]\n",
    "        last_pos = xb[:, -1, :2]              # [B, 2]\n",
    "        preds_abs = preds_rel + last_pos.unsqueeze(1)\n",
    "        next_xy = preds_abs[:, 0, :]          # åªå–ç¬¬ 1 å¸§ [B, 2]\n",
    "\n",
    "    preds_np = next_xy.cpu().numpy()\n",
    "    preds_df = pd.DataFrame({\n",
    "        \"x\": preds_np[:, 0],\n",
    "        \"y\": preds_np[:, 1],\n",
    "    })\n",
    "\n",
    "    assert len(preds_df) == len(test_pd)\n",
    "\n",
    "    # --- æŒ‰æ¨¡æ¿è¦æ±‚è¿”å› pandas æˆ– polars ---\n",
    "    if original_is_polars:\n",
    "        return pl.from_pandas(preds_df)\n",
    "    else:\n",
    "        return preds_df\n"
   ]
  },
  {
   "cell_type": "code",
   "execution_count": 25,
   "id": "fda453a5",
   "metadata": {
    "execution": {
     "iopub.execute_input": "2025-11-27T03:29:41.786016Z",
     "iopub.status.busy": "2025-11-27T03:29:41.785822Z",
     "iopub.status.idle": "2025-11-27T03:30:07.742322Z",
     "shell.execute_reply": "2025-11-27T03:30:07.741619Z"
    },
    "papermill": {
     "duration": 25.965181,
     "end_time": "2025-11-27T03:30:07.743777",
     "exception": false,
     "start_time": "2025-11-27T03:29:41.778596",
     "status": "completed"
    },
    "tags": []
   },
   "outputs": [],
   "source": [
    "import kaggle_evaluation.nfl_inference_server as nfl_inference_server\n",
    "import os\n",
    "\n",
    "inference_server = nfl_inference_server.NFLInferenceServer(predict)\n",
    "\n",
    "if os.getenv(\"KAGGLE_IS_COMPETITION_RERUN\"):\n",
    "    inference_server.serve()  # çœŸæ­£ hidden test ä½¿ç”¨\n",
    "else:\n",
    "    inference_server.run_local_gateway((\"/kaggle/input/nfl-big-data-bowl-2026-prediction\",))\n"
   ]
  }
 ],
 "metadata": {
  "kaggle": {
   "accelerator": "nvidiaTeslaT4",
   "dataSources": [
    {
     "databundleVersionId": 14210809,
     "sourceId": 114239,
     "sourceType": "competition"
    }
   ],
   "dockerImageVersionId": 31193,
   "isGpuEnabled": true,
   "isInternetEnabled": false,
   "language": "python",
   "sourceType": "notebook"
  },
  "kernelspec": {
   "display_name": "Python 3",
   "language": "python",
   "name": "python3"
  },
  "language_info": {
   "codemirror_mode": {
    "name": "ipython",
    "version": 3
   },
   "file_extension": ".py",
   "mimetype": "text/x-python",
   "name": "python",
   "nbconvert_exporter": "python",
   "pygments_lexer": "ipython3",
   "version": "3.11.13"
  },
  "papermill": {
   "default_parameters": {},
   "duration": 1918.563647,
   "end_time": "2025-11-27T03:30:10.484750",
   "environment_variables": {},
   "exception": null,
   "input_path": "__notebook__.ipynb",
   "output_path": "__notebook__.ipynb",
   "parameters": {},
   "start_time": "2025-11-27T02:58:11.921103",
   "version": "2.6.0"
  }
 },
 "nbformat": 4,
 "nbformat_minor": 5
}
